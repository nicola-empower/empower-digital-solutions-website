---
import { Search as SearchIcon } from "lucide-astro";
---

<div class="relative group search-widget">
    <div
        class="flex items-center bg-gray-100 dark:bg-slate-800 rounded-full px-4 py-2 focus-within:ring-2 focus-within:ring-empower-pink transition-all border border-transparent focus-within:border-empower-pink/50"
    >
        <SearchIcon class="w-4 h-4 text-gray-500 mr-2" />
        <input
            type="text"
            placeholder="Search..."
            class="bg-transparent border-none outline-none text-sm text-gray-700 dark:text-gray-200 w-24 focus:w-48 transition-all placeholder-gray-400"
            id="search-input"
        />
    </div>

    <div
        id="search-results"
        class="absolute top-full right-0 mt-2 w-72 bg-white dark:bg-slate-900 rounded-xl shadow-2xl border border-gray-100 dark:border-slate-800 overflow-hidden hidden"
    >
    </div>
</div>

<script>
    const searchInput = document.getElementById(
        "search-input",
    ) as HTMLInputElement;
    const searchResults = document.getElementById("search-results");

    let items = [];

    // Fetch items once on hover to save bandwidth
    const searchWidget = document.querySelector(".search-widget");
    searchWidget?.addEventListener("mouseenter", async () => {
        if (items.length === 0) {
            const res = await fetch("/search.json");
            items = await res.json();
        }
    });

    searchInput?.addEventListener("input", (e) => {
        const term = (e.target as HTMLInputElement).value.toLowerCase();

        if (term.length < 2) {
            searchResults?.classList.add("hidden");
            return;
        }

        const filtered = items.filter(
            (item: any) =>
                item.title.toLowerCase().includes(term) ||
                item.description.toLowerCase().includes(term),
        );

        if (filtered.length > 0) {
            searchResults!.innerHTML = `
        <div class="p-2">
           <div class="text-xs font-bold text-gray-400 px-3 py-1 uppercase tracking-wider">Results</div>
           ${filtered
               .slice(0, 5)
               .map(
                   (item: any) => `
             <a href="${item.slug}" class="block px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors">
               <div class="text-sm font-bold text-gray-900 dark:text-gray-100">${item.title}</div>
               <div class="text-xs text-gray-500 truncate">${item.description}</div>
               <div class="text-[10px] text-empower-pink mt-1 uppercase font-bold">${item.type}</div>
             </a>
           `,
               )
               .join("")}
        </div>
      `;
            searchResults?.classList.remove("hidden");
        } else {
            searchResults!.innerHTML = `
            <div class="p-4 text-center text-sm text-gray-500">
                No results found.
            </div>
        `;
            searchResults?.classList.remove("hidden");
        }
    });

    // Close on click outside
    document.addEventListener("click", (e) => {
        if (!searchWidget?.contains(e.target as Node)) {
            searchResults?.classList.add("hidden");
        }
    });
</script>
