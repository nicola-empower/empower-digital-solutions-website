---
import Layout from "../../layouts/Layout.astro";
---

<Layout title="Admin Dashboard | Empower Digital Solutions">
    <div class="min-h-screen bg-slate-950 pt-24 px-6">
        <div class="container mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-white">Lead Management</h1>
                <button
                    id="logout-btn"
                    class="text-slate-400 hover:text-white transition-colors"
                    >Logout</button
                >
            </div>

            <div
                class="bg-slate-900 rounded-2xl border border-slate-800 overflow-hidden"
            >
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-slate-300">
                        <thead
                            class="bg-slate-800 text-slate-100 uppercase text-xs font-bold"
                        >
                            <tr>
                                <th class="px-6 py-4">Date</th>
                                <th class="px-6 py-4">Name</th>
                                <th class="px-6 py-4">Email</th>
                                <th class="px-6 py-4">Service</th>
                                <th class="px-6 py-4">Message</th>
                                <th class="px-6 py-4">Status</th>
                            </tr>
                        </thead>
                        <tbody
                            id="leads-table-body"
                            class="divide-y divide-slate-800"
                        >
                            <!-- Leads will be injected here -->
                            <tr>
                                <td
                                    colspan="6"
                                    class="px-6 py-8 text-center text-slate-500"
                                    >Loading leads...</td
                                >
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</Layout>

<script>
    import { supabase } from "../../lib/supabase";

    // Auth Check
    const {
        data: { session },
    } = await supabase.auth.getSession();
    if (!session) {
        window.location.href = "/admin";
    }

    // Logout
    const logoutBtn = document.getElementById("logout-btn");
    if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
            await supabase.auth.signOut();
            window.location.href = "/admin";
        });
    }

    // Fetch Leads
    async function fetchLeads() {
        const { data: leads, error } = await supabase
            .from("leads")
            .select("*")
            .order("created_at", { ascending: false });

        const tbody = document.getElementById("leads-table-body");
        if (!tbody) return;

        if (error) {
            tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-red-400">Error loading leads: ${error.message}</td></tr>`;
            return;
        }

        if (!leads || leads.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-slate-500">No leads found.</td></tr>`;
            return;
        }

        tbody.innerHTML = leads
            .map(
                (lead: any) => `
      <tr class="hover:bg-slate-800/50 transition-colors">
        <td class="px-6 py-4 text-sm">${new Date(lead.created_at).toLocaleDateString()}</td>
        <td class="px-6 py-4 font-medium text-white">${lead.name}</td>
        <td class="px-6 py-4 text-sm">${lead.email}</td>
        <td class="px-6 py-4 text-sm"><span class="bg-purple-900/30 text-purple-300 px-2 py-1 rounded text-xs">${lead.service || "General"}</span></td>
        <td class="px-6 py-4 text-sm max-w-xs truncate" title="${lead.message}">${lead.message}</td>
        <td class="px-6 py-4">
           <span class="bg-green-900/30 text-green-300 px-2 py-1 rounded text-xs uppercase font-bold">New</span>
        </td>
      </tr>
    `,
            )
            .join("");
    }

    fetchLeads();
</script>
